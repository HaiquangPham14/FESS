<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samsung Galaxy A Series - Mosaic Artwork</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: url('https://cdn.jsdelivr.net/gh/HaiquangPham14/SSMosaicDetectHTH@main/LANDING%20PAGE_3.png') no-repeat center center fixed;
            background-size: contain;
            min-height: 100vh;
            width: 100vw;
            overflow: auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            padding: 20px;
        }

        /* ========== PROGRESS BAR DESIGN ========== */
        .progress-container {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 18px 18px 0 0;
            padding: 24px 18px 20px 18px;
            width: 100%;
            max-width: 980px;
            min-width: 200px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: -10px;
            z-index: 100;
            position: relative;
        }

        .progress-bar {
            height: 48px;
            width: 100%;
            background: rgba(250, 250, 250, 0.85);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 24px 0 rgba(255, 64, 255, 0.10);
            border: 2px solid #ffa9fd;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff1aff 0%, #fd5afd 100%);
            border-radius: 16px 0 0 16px;
            width: 0%;
            min-width: 0;
            max-width: 100%;
            transition: width 1s cubic-bezier(.98,.03,.28,.99);
            position: absolute;
            left: 0; top: 0;
            z-index: 1;
        }

        .progress-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.6rem;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #fe5fff 30%, #ff1aff 80%);
            color: #fff;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            text-shadow: 0 3px 15px #fd5afd88, 0 1px 2px #fd5afd44;
            filter: drop-shadow(0 4px 12px #ffb8ff);
            z-index: 2;
            user-select: none;
            pointer-events: none;
            transition: font-size 0.2s, text-shadow 0.2s;
        }

        /* ========== END PROGRESS BAR DESIGN ========== */

        .mosaic-section {
            width: 100%;
            max-width: 900px;
            aspect-ratio: 16/9;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 0 0 30px 30px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 50px rgba(11, 183, 175, 0.15);
            z-index: 10;
        }

        .mosaic-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            cursor: grab;
            touch-action: none;
        }

        .mosaic-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        .background-under-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: fill;
            z-index: 0;
            pointer-events: none;
        }

        .mosaic-scale-wrapper {
            position: absolute;
            top: 46%;
            left: 46%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%) scale(0.8);
        }

        .background-image,
        .mosaic-grid {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .background-image {
            z-index: 1;
            pointer-events: none;
        }

        .mosaic-grid {
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .grid-cell {
            overflow: hidden;
            position: absolute;
            transition: all 0.3s ease;
        }

        .grid-cell img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            filter: brightness(1.1);
            transition: all 0.5s ease;
            opacity: 0.5;
        }

        /* === Responsive CSS === */
        @media (max-width: 900px) {
            .main-container {
                padding: 10px;
            }
            .mosaic-section {
                max-width: 98vw;
                aspect-ratio: 16/9;
            }
            .progress-container {
                max-width: 98vw;
                min-width: 140px;
                padding: 18px 6px 14px 6px;
            }
            .progress-bar {
                height: 40px;
            }
            .progress-text {
                font-size: 1.16rem;
            }
        }

        @media (max-width: 600px) {
            .main-container {
                transform: scale(0.95);
            }
            .mosaic-section {
                max-width: 100vw;
                border-radius: 0 0 15px 15px;
            }
            .progress-container {
                max-width: 100vw;
                min-width: 90px;
                padding: 8px 2px 7px 2px;
                border-radius: 12px 12px 0 0;
            }
            .progress-bar {
                height: 32px;
            }
            .progress-text {
                font-size: 0.98rem;
            }
        }

        @media (max-height: 700px) {
            .main-container {
                transform: scale(0.9);
            }
        }

        @media (max-height: 600px) {
            .main-container {
                transform: scale(0.8);
            }
        }

        /* Tối ưu cho điện thoại nằm ngang */
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 10px;
                overflow: auto;
                min-height: 100vh;
                min-width: 100vw;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .main-container {
                width: 90%;
                height: auto;
                min-height: unset;
                min-width: unset;
                margin: 0;
                padding: 0;
                transform: none;
                justify-content: flex-start;
            }
            .mosaic-section {
                width: 80%;
                height: 60vh;
                min-height: 220px;
                border-radius: 0 0 15px 15px;
                margin: 0 auto;
            }
            .progress-container {
                width: 80%;
                min-width: 90px;
                margin: 0;
                border-radius: 12px 12px 0 0;
                padding: 8px 6px;
            }
            .progress-bar {
                height: 28px;
            }
            .progress-text {
                font-size: 0.92rem;
            }
            .mosaic-scale-wrapper {
                position: absolute;
                top: 46%;
                left: 46%;
                width: 100%;
                height: 100%;
                transform: translate(-50%, -50%) scale(0.8);
            }
            .grid-cell img {
                opacity: 0.7;
            }
        }

        @media (orientation: landscape) and (max-height: 400px) {
            .mosaic-section {
                width: 70vw !important;
                height: 60vh !important;
            }
            .progress-container {
                width: 70vw !important;
            }
            .progress-bar {
                height: 18px;
            }
            .progress-text {
                font-size: 0.8rem;
            }
            .mosaic-scale-wrapper {
                position: absolute;
                top: 46%;
                left: 46%;
                width: 100%;
                height: 100%;
                transform: translate(-50%, -50%) scale(0.8);
            }
            .grid-cell img {
                opacity: 0.8;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-text" id="progressText">SUNDAYs ĐÃ THAM GIA: 0</div>
            </div>
        </div>
        <div class="mosaic-section">
            <div class="mosaic-container" id="mosaicContainer">
                <div class="mosaic-wrapper" id="mosaicWrapper">
                    <!-- Ảnh nền phụ phía dưới -->
                    <img class="background-under-image"
                        src="https://cdn.jsdelivr.net/gh/HaiquangPham14/mosaicPicSS@main/Mosaic%20HTH.png"
                        alt="Nền phụ">
                    <div class="mosaic-scale-wrapper">
                        <img class="background-image" id="backgroundImage" crossorigin="anonymous"
                            src="https://cdn.jsdelivr.net/gh/HaiquangPham14/mosaicPicSS@main/sshth.png"
                            alt="Khung ảnh mosaic">
                        <div class="mosaic-grid" id="mosaicGrid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Grid nhỏ hơn, tối đa 1000 ô. Ví dụ: 40 x 25 = 1000
        const gridCols = 40;
        const gridRows = 25;
        const API_BASE_URL = 'https://upimgss.azurewebsites.net/api/SSImage';
        const mosaicGrid = document.getElementById('mosaicGrid');
        const mosaicContainer = document.getElementById('mosaicContainer');
        const mosaicWrapper = document.getElementById('mosaicWrapper');
        const backgroundImage = document.getElementById('backgroundImage');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let startX, startY;
        let lastTouchDistance = null;
        let cellSize = { width: 0, height: 0 };

        function calculateCellSize() {
            const containerRect = mosaicContainer.getBoundingClientRect();
            return {
                width: containerRect.width / gridCols,
                height: containerRect.height / gridRows
            };
        }

        function updateGridCells() {
            cellSize = calculateCellSize();
            const gridCells = document.querySelectorAll('.grid-cell');
            gridCells.forEach(cell => {
                const col = cell.dataset.col;
                const row = cell.dataset.row;
                cell.style.width = `${cellSize.width}px`;
                cell.style.height = `${cellSize.height}px`;
                cell.style.left = `${col * cellSize.width}px`;
                cell.style.top = `${row * cellSize.height}px`;
            });
        }

        function handleResize() {
            updateGridCells();
            resetZoom();
        }

        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise((resolve) => {
                if (backgroundImage.complete) resolve();
                else backgroundImage.onload = resolve;
            });

            updateGridCells();
            await createMosaicGridForNonTransparentAreas();
            loadApprovedImages();
            setupZoomAndPan();
            startRealtimeUpdates();

            window.addEventListener('resize', debounce(handleResize, 250));
        });

        async function createMosaicGridForNonTransparentAreas() {
            mosaicGrid.innerHTML = '';
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const containerRect = mosaicContainer.getBoundingClientRect();

            canvas.width = containerRect.width;
            canvas.height = containerRect.height;
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            for (let row = 0; row < gridRows; row++) {
                for (let col = 0; col < gridCols; col++) {
                    const x = col * cellSize.width;
                    const y = row * cellSize.height;
                    const pixelData = ctx.getImageData(
                        Math.floor(x + cellSize.width / 2),
                        Math.floor(y + cellSize.height / 2),
                        1, 1
                    ).data;
                    if (pixelData[3] > 10) {
                        createGridCell(col, row);
                    }
                }
            }
        }

        function createGridCell(col, row) {
            const position = row * gridCols + col + 1;
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.position = position;
            cell.dataset.col = col;
            cell.dataset.row = row;
            cell.style.width = `${cellSize.width}px`;
            cell.style.height = `${cellSize.height}px`;
            cell.style.left = `${col * cellSize.width}px`;
            cell.style.top = `${row * cellSize.height}px`;
            mosaicGrid.appendChild(cell);
            return cell;
        }

        async function loadApprovedImages() {
            try {
                const gridCells = document.querySelectorAll('.grid-cell');
                const response = await axios.get(`${API_BASE_URL}/approved?pageSize=${gridCells.length}`);
                const images = response.data.data || [];
                gridCells.forEach((cell, i) => {
                    if (images[i]) {
                        const oldImg = cell.querySelector('img');
                        if (oldImg) cell.removeChild(oldImg);
                        const img = document.createElement('img');
                        img.src = images[i].imgUrl;
                        img.alt = `Ảnh mosaic vị trí ${i + 1}`;
                        img.style.opacity = calculateOpacity(scale);
                        cell.appendChild(img);
                    }
                });
                updateProgress(images.length);
            } catch (error) {
                console.error('Lỗi khi tải ảnh đã duyệt:', error);
            }
        }

        function updateProgress(filledCount) {
            const totalCells = document.querySelectorAll('.grid-cell').length;
            const progress = Math.round((filledCount / totalCells) * 100);
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `SUNDAYs ĐÃ THAM GIA: ${filledCount}`;
        }

        function calculateOpacity(currentScale) {
            if (currentScale <= 1) return 0.3;
            else if (currentScale >= 3) return 1;
            else return 0.5 + (currentScale - 1) * 0.25;
        }

        function updateOpacity() {
            const images = document.querySelectorAll('.grid-cell img');
            const opacity = calculateOpacity(scale);
            images.forEach(img => {
                img.style.opacity = opacity;
            });
        }

        function constrainTranslation() {
            const containerRect = mosaicContainer.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;
            const scaledWidth = containerWidth * scale;
            const scaledHeight = containerHeight * scale;
            const maxTranslateX = Math.max(0, (containerWidth - scaledWidth) / 2);
            const minTranslateX = Math.min(0, -(scaledWidth - containerWidth) + maxTranslateX);
            const maxTranslateY = Math.max(0, (containerHeight - scaledHeight) / 2);
            const minTranslateY = Math.min(0, -(scaledHeight - containerHeight) + maxTranslateY);
            translateX = Math.max(minTranslateX, Math.min(maxTranslateX, translateX));
            translateY = Math.max(minTranslateY, Math.min(maxTranslateY, translateY));
        }

        function applyTransform() {
            mosaicWrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        function resetZoom() {
            scale = 1;
            translateX = 0;
            translateY = 0;
            applyTransform();
            updateOpacity();
        }

        function zoom(zoomFactor, centerX, centerY) {
            const newScale = Math.max(1, Math.min(4, scale * zoomFactor));
            if (newScale === scale) return;
            const rect = mosaicContainer.getBoundingClientRect();
            const xPercent = (centerX - rect.left) / rect.width;
            const yPercent = (centerY - rect.top) / rect.height;
            const dx = (xPercent - 0.5) * rect.width * (1 - (newScale / scale));
            const dy = (yPercent - 0.5) * rect.height * (1 - (newScale / scale));
            scale = newScale;
            translateX += dx;
            translateY += dy;
            constrainTranslation();
            applyTransform();
            updateOpacity();
        }

        function setupZoomAndPan() {
            mosaicContainer.addEventListener('wheel', handleWheel);
            mosaicContainer.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            mosaicContainer.addEventListener('touchstart', handleTouchStart);
            mosaicContainer.addEventListener('touchmove', handleTouchMove);
            mosaicContainer.addEventListener('touchend', handleTouchEnd);
            mosaicContainer.addEventListener('dblclick', resetZoom);
        }

        function handleWheel(e) {
            e.preventDefault();
            const zoomIntensity = 0.1;
            const wheelDelta = e.deltaY;
            let zoomFactor = 1 + (wheelDelta < 0 ? zoomIntensity : -zoomIntensity);
            zoom(zoomFactor, e.clientX, e.clientY);
        }

        function startDrag(e) {
            if (e.button !== 0) return;
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            mosaicContainer.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            constrainTranslation();
            applyTransform();
        }

        function endDrag() {
            isDragging = false;
            mosaicContainer.style.cursor = 'grab';
        }

        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
            } else if (e.touches.length === 2) {
                isDragging = false;
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 1 && isDragging) {
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                constrainTranslation();
                applyTransform();
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const touchDistance = Math.sqrt(dx * dx + dy * dy);
                if (lastTouchDistance !== null) {
                    const zoomFactor = touchDistance / lastTouchDistance;
                    const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    zoom(zoomFactor, midX, midY);
                }
                lastTouchDistance = touchDistance;
            }
        }

        function handleTouchEnd() {
            isDragging = false;
            lastTouchDistance = null;
        }

        function startRealtimeUpdates() {
            setInterval(async () => {
                try {
                    loadApprovedImages();
                } catch (error) {
                    console.error('Lỗi khi cập nhật realtime:', error);
                }
            }, 10000);
        }
    </script>
</body>

</html>